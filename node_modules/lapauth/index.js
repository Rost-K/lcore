var Cookies = require("cookies");
module.exports = function (config, appStructure) {
    var db = appStructure.db;
    return function (req, res, next) {
        var cookies = new Cookies(req, res);
        if (typeof req.errors == 'undefined') req.errors = [];
        if (req.session.user) {
            req.user = req.session.user;
            next();
        } else {
            if (req.body.admin_login && req.body.admin_password) {
                var adminsCollection = db.collection('admins');
                adminsCollection.findOne({
                        mail: req.body.admin_login,
                        pass: req.body.admin_password
                    },
                    function(err, result) {
                        /* if (err) throw err;
                         callback({data: {page: result}}) */
                        if (err) {
                            req.errors.push({id:'DB_ERROR', data:err});
                        } else {
                            if (result != null) {
                                delete result.pass;
                                req.session.user = result;
                                req.user = result;
                                cookies.set('lc.user', JSON.stringify(result), {path:'/', httpOnly: false});
                            } else {
                                req.errors.push({id: 'AUTH_WRONG_USER', data:{}})
                            }
                        }
                        next()
                    }
                )
            } else {
                next()
            }

        }
    }
}